# M5: Flutter Desktop Plugin (macOS + Linux)

## Goal

Flutter plugin wrapping the pure Dart FFI package (M3) with background
Isolate execution. First Flutter-dependent code in the project.

## Risk Addressed

- **R6** (UI thread blocking) -- Isolate execution
- **R7** (native library bundling) -- podspec + CMakeLists
- **R8** (federated plugin wiring) -- correct `default_package`

## Deliverable

- `packages/dart_monty_desktop` -- Flutter plugin for macOS + Linux
- `dart_monty` root package -- app-facing API with `FlutterMonty`
- `example/` -- working Flutter example app

## Usable For

Flutter desktop apps on macOS and Linux.

## Known Risks (from review)

### Isolate crash hangs main thread

If Rust panics or segfaults, the background Isolate dies silently. Any
main-thread `Future` awaiting a `ReceivePort` response will hang forever.
**Mitigation:** `Isolate.addOnExitListener` and `addErrorListener` must
complete all pending Futures with a `MontyException` on unexpected exit.

### Native library resolution in bundled apps

`NativeLibraryLoader.resolve()` is hardcoded for pure Dart test paths.
In a Flutter app bundle the library lives in `Frameworks/` (macOS) or
`lib/` (Linux). **Mitigation:** add a fallback path strategy --
try `DynamicLibrary.process()` on macOS, and use
`Platform.resolvedExecutable`-relative paths for Linux.

### macOS code signing

Raw `.dylib` files can trigger Gatekeeper or App Store rejections.
**Mitigation:** the podspec must use `vendored_libraries` (or package as
`.xcframework`) so Xcode embeds and signs the library correctly.

### Disposal race condition

`dispose()` called while an iterative `start()` is in-flight must
cleanly tear down the Isolate. **Mitigation:** the Isolate message
loop must drain pending work, call `_bindings.free(handle)`, then exit.

## Work Items

### 5.1 Federated Plugin Wiring

Root `dart_monty/pubspec.yaml`:

```yaml
flutter:
  plugin:
    platforms:
      macos:
        default_package: dart_monty_desktop
      linux:
        default_package: dart_monty_desktop
```

`packages/dart_monty_desktop/pubspec.yaml` (note `dartPluginClass`
is required to trigger automatic `registerWith()` invocation):

```yaml
flutter:
  plugin:
    implements: dart_monty
    platforms:
      macos:
        pluginClass: none
        dartPluginClass: DartMontyDesktop
        ffiPlugin: true
      linux:
        pluginClass: none
        dartPluginClass: DartMontyDesktop
        ffiPlugin: true
```

- [x] Root pubspec uses `default_package` (remove existing `ffiPlugin: true` from macos/linux blocks)
- [x] Desktop package has `flutter.plugin.implements`
- [x] Desktop package declares `dartPluginClass: DartMontyDesktop`
- [x] `registerWith()` static method
- [x] No method channels

### 5.2 Native Library Bundling

- [x] `packages/dart_monty_desktop/macos/dart_monty_desktop.podspec`
  - Use `vendored_libraries` for proper code signing
- [x] `packages/dart_monty_desktop/linux/CMakeLists.txt`
  - Install `.so` to `${CMAKE_INSTALL_PREFIX}/lib` with correct rpath
- [x] `tool/build_native.sh`: build Rust, copy to platform dirs
- [x] Update `NativeLibraryLoader` with fallback path strategy for bundled apps
  - macOS: try `DynamicLibrary.process()` fallback
  - Linux: `Platform.resolvedExecutable`-relative path fallback

### 5.3 Isolate Execution

- [x] `FlutterMonty` class wrapping `Monty` (from dart_monty_ffi)
- [x] `Isolate.spawn()` loads native library in background
- [x] `SendPort`/`ReceivePort` communication with Request/Response ID matching
- [x] Commands: run, start, resume, resumeWithError, snapshot, dispose
- [x] External function callbacks via Isolate message passing
- [x] `Isolate.addOnExitListener` -- complete pending Futures with `MontyException` on crash
- [x] `Isolate.addErrorListener` -- surface Isolate errors to callers
- [x] Use `TransferableTypedData` for snapshot `Uint8List` to avoid copy overhead
- [x] Graceful disposal: drain pending work before killing Isolate

### 5.4 Example App

- [x] `example/` Flutter app:
  - Python code input (text field)
  - Run button
  - Output display
  - Resource usage display
  - Works on macOS and Linux

### 5.5 Python Compatibility Ladder (via Isolate)

All ladder tiers (1-6+) must pass through `FlutterMonty` (Isolate
execution) on desktop. The ladder runner is reused from M3 but executed
via the Flutter Isolate path instead of direct FFI.

- [x] All tiers pass through `FlutterMonty` on macOS
- [x] All tiers pass through `FlutterMonty` on Linux
- [x] Verifies Isolate message passing doesn't corrupt results

### 5.6 Automated Tests

- [x] `tool/test_desktop.sh`:
  1. Build native library
  2. `flutter test packages/dart_monty_desktop`
  3. `flutter test example/`
  4. `tool/test_python_ladder.sh --runner=flutter-isolate`
- [x] Isolate lifecycle: create, run, dispose, double-dispose
- [x] Isolate crash recovery: verify pending Futures fail cleanly
- [x] Concurrent execution (multiple FlutterMonty instances)
- [x] External function callback round-trip
- [x] Widget tests for example app
- [x] Python ladder tiers 1-6+ via Isolate

### CI Expansion

When M5 completes, enable the following:

**CI workflow (`.github/workflows/ci.yaml`):**

- Add `dart_monty_desktop` to the `test` job matrix (`flutter test --coverage`)
- Add coverage check for `dart_monty_desktop` (>= 90% gate)
- Add root `dart_monty` package to test matrix (`flutter test --coverage` at repo root)
- Add coverage check for root `dart_monty` (>= 90% gate)
- Expand `build-native` job to produce artifacts consumed by desktop test jobs
- Add `python-ladder-isolate` job: `tool/test_python_ladder.sh --paths=flutter-isolate --tiers=1-6` on macOS and Linux runners
- Add `build-smoke` job: `flutter build macos` on macos-latest, `flutter build linux` on ubuntu-latest
  - **Linux desktop build requirements:** the `ubuntu-latest` runner must install `clang`, `cmake`, `ninja-build`, `pkg-config`, and `libgtk-3-dev` before `flutter build linux` (e.g., `sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev`)
- Begin release pipeline scaffolding: draft workflow for `pub.dev` dry-run publish checks

**Pre-commit hooks (`.pre-commit-config.yaml`):**

- Add `flutter-test-desktop` hook: `cd packages/dart_monty_desktop && flutter test`
- Add `flutter-analyze` hook: `flutter analyze --fatal-infos` at repo root (replaces `dart analyze` for Flutter-aware analysis)

## Implementation Order

Recommended sequence to avoid blocking:

1. **5.2 Native bundling + build scripts** -- hardest infrastructure hurdle first
2. **5.1 + 5.4 Federated wiring + example app skeleton** -- verify library resolves in a real Flutter app
3. **5.3 (part 1) Isolate core** -- `FlutterMonty`, spawn, message loop, simple `run()`
4. **5.5 Python ladder via Isolate** -- validate non-iterative execution
5. **5.3 (part 2) Iterative API** -- `start`, `resume`, `resumeWithError` with state routing
6. **5.6 + CI Tests and CI expansion** -- gate scripts, coverage, workflows

## Quality Gate

```bash
cd packages/dart_monty_desktop
flutter pub get
dart format --set-exit-if-changed .
flutter analyze --fatal-infos
flutter test --coverage
# Coverage must be >= 90%

# Python ladder via Isolate:
tool/test_python_ladder.sh --runner=flutter-isolate

cd ../../example
flutter build macos    # build smoke test
flutter build linux    # build smoke test
```

## Test Dependencies

| Tool | Purpose |
|------|---------|
| Flutter SDK | Plugin framework, test runner |
| Native library from M2 | FFI backend |
| macOS / Linux host | Platform targets |
