# M5: Flutter Desktop Plugin (macOS + Linux)

## Goal

Flutter plugin wrapping the pure Dart FFI package (M3) with background
Isolate execution. First Flutter-dependent code in the project.

## Risk Addressed

- **R6** (UI thread blocking) -- Isolate execution
- **R7** (native library bundling) -- podspec + CMakeLists
- **R8** (federated plugin wiring) -- correct `default_package`

## Deliverable

- `packages/dart_monty_desktop` -- Flutter plugin for macOS + Linux
- `dart_monty` root package -- app-facing API with `FlutterMonty`
- `example/` -- working Flutter example app

## Usable For

Flutter desktop apps on macOS and Linux.

## Work Items

### 5.1 Federated Plugin Wiring

Root `dart_monty/pubspec.yaml`:

```yaml
flutter:
  plugin:
    platforms:
      macos:
        default_package: dart_monty_desktop
      linux:
        default_package: dart_monty_desktop
```

`packages/dart_monty_desktop/pubspec.yaml`:

```yaml
flutter:
  plugin:
    implements: dart_monty
    platforms:
      macos:
        pluginClass: none
        ffiPlugin: true
      linux:
        pluginClass: none
        ffiPlugin: true
```

- [ ] Root pubspec uses `default_package`
- [ ] Desktop package has `flutter.plugin.implements`
- [ ] `registerWith()` static method
- [ ] No method channels

### 5.2 Native Library Bundling

- [ ] `packages/dart_monty_desktop/macos/dart_monty_desktop.podspec`
- [ ] `packages/dart_monty_desktop/linux/CMakeLists.txt`
- [ ] `tool/build_native.sh`: build Rust, copy to platform dirs

### 5.3 Isolate Execution

- [ ] `FlutterMonty` class wrapping `Monty` (from dart_monty_ffi)
- [ ] `Isolate.spawn()` loads native library in background
- [ ] `SendPort`/`ReceivePort` communication
- [ ] Commands: run, start, resume, resumeWithError, snapshot, dispose
- [ ] External function callbacks via Isolate message passing

### 5.4 Example App

- [ ] `example/` Flutter app:
  - Python code input (text field)
  - Run button
  - Output display
  - Resource usage display
  - Works on macOS and Linux

### 5.5 Python Compatibility Ladder (via Isolate)

All ladder tiers (1-6+) must pass through `FlutterMonty` (Isolate
execution) on desktop. The ladder runner is reused from M3 but executed
via the Flutter Isolate path instead of direct FFI.

- [ ] All tiers pass through `FlutterMonty` on macOS
- [ ] All tiers pass through `FlutterMonty` on Linux
- [ ] Verifies Isolate message passing doesn't corrupt results

### 5.6 Automated Tests

- [ ] `tool/test_desktop.sh`:
  1. Build native library
  2. `flutter test packages/dart_monty_desktop`
  3. `flutter test example/`
  4. `tool/test_python_ladder.sh --runner=flutter-isolate`
- [ ] Isolate lifecycle: create, run, dispose, double-dispose
- [ ] Concurrent execution (multiple FlutterMonty instances)
- [ ] External function callback round-trip
- [ ] Widget tests for example app
- [ ] Python ladder tiers 1-6+ via Isolate

## Quality Gate

```bash
cd packages/dart_monty_desktop
flutter pub get
dart format --set-exit-if-changed .
flutter analyze --fatal-infos
flutter test --coverage
# Coverage must be >= 90%

# Python ladder via Isolate:
tool/test_python_ladder.sh --runner=flutter-isolate

cd ../../example
flutter build macos    # build smoke test
flutter build linux    # build smoke test
```

## Test Dependencies

| Tool | Purpose |
|------|---------|
| Flutter SDK | Plugin framework, test runner |
| Native library from M2 | FFI backend |
| macOS / Linux host | Platform targets |
