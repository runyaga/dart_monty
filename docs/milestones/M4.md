# M4: Pure Dart WASM Package

**Prerequisite:** M3 web spike passed (GO decision).

## Goal

Full `dart_monty_wasm` package. Any Dart program compiled to WASM can
run Python in a browser. No Flutter dependency.

## Risk Addressed

- **R1** (web viability -- full implementation, not spike)

## Deliverable

`packages/dart_monty_wasm` -- pure Dart package implementing `MontyPlatform`
via `dart:js_interop` calling into Monty WASM.

## Usable For

- Dart web apps (compiled with `dart compile wasm`)
- Browser-based tools and editors
- Pure Dart WASM programs (no Flutter)

## Work Items

### 4.1 JS Wrapper Module

- [ ] `packages/dart_monty_wasm/js/wrapper.js`:
  - Loads Monty WASM binary (built from same source in M2)
  - Exposes `window.DartMontyBridge` global with simplified API
  - Handles WASI initialization and SharedArrayBuffer setup
- [ ] `packages/dart_monty_wasm/js/package.json` with `esbuild` dev dep
- [ ] `packages/dart_monty_wasm/js/build.js` -- esbuild bundler script
- [ ] Output: `packages/dart_monty_wasm/assets/dart_monty_bridge.js`
- [ ] Output: `packages/dart_monty_wasm/assets/monty.wasm` (from M2)

### 4.2 Dart JS Interop Bindings

- [ ] `dart:js_interop` type definitions for `window.DartMontyBridge`
- [ ] `MontyWasm` class implementing `MontyPlatform`
- [ ] All execution is async (web is inherently async)
- [ ] `resumeWithError()` support
- [ ] Snapshot support via JS bridge

### 4.3 Python Compatibility Ladder (continued)

The ladder from M3 continues to gate M4. All existing tiers (1-6) must
pass through the `dart_monty_wasm` package (not just the spike).

New tiers added as Monty gains features (classes, async, dataclasses, etc.)
are dropped into `test/fixtures/python_ladder/` and automatically picked
up by the test runner.

- [ ] All M3 tiers (1-6) pass through `dart_monty_wasm` on headless Chrome
- [ ] Add tiers 7+ if Monty's pinned rev supports new features (classes, async)
- [ ] `tool/test_python_ladder.sh` updated to run against `dart_monty_wasm`

### 4.4 Automated Tests

Tests run in headless Chrome. Require Node.js/Bun for building JS wrapper.

- [ ] `tool/test_wasm.sh`:
  1. `cd packages/dart_monty_wasm/js && npm install && npm run build`
  2. `cd packages/dart_monty_wasm && dart test --platform chrome`
- [ ] Test cases:
  - Simple execution (run Python, get result)
  - Iterative execution (external function calls)
  - Resume with error
  - Snapshots (create, restore)
  - Resource limits
  - Error handling (invalid code, timeouts)
  - Type mapping (all Python types -> Dart types)
  - Python ladder tiers 1-6 (and any new tiers)

## Quality Gate

```bash
cd packages/dart_monty_wasm
cd js && npm install && npm run build && cd ..
dart pub get
dart format --set-exit-if-changed .
dart analyze --fatal-infos
dart test --platform chrome --coverage=coverage
# Coverage must be >= 90%

# Python ladder (all tiers, both paths):
tool/test_python_ladder.sh
```

## Test Dependencies

| Tool | Purpose |
|------|---------|
| Dart SDK | Compiler, test runner |
| Node.js or Bun | Build JS wrapper (`esbuild`) |
| Chrome (headless) | Browser test runner |
| WASM binary from M2 | Monty runtime |

## COOP/COEP Note

Tests must run with cross-origin isolation headers. The test runner
or dev server must serve:
```
Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Embedder-Policy: require-corp
```
