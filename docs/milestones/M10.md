# M10: Hardening and Cross-Platform Testing

## Goal

Production-ready quality. Stress tests, comprehensive snapshot portability,
performance benchmarks, and full coverage enforcement. Runs after M7A/M7B/M8
so it validates the complete, stabilized API surface — not a partial one.

## Risk Addressed

- Undetected memory leaks under sustained use
- Snapshot format incompatibilities across platforms
- Performance regressions without baseline benchmarks
- Coverage gaps masked by happy-path testing

## Dependencies

- M7A, M7B (Run API fidelity + behavioral extensions) — API surface must
  be stable before hardening validates it
- M8 (Rich Type Bridge) — type bridge must be complete
- M9 (Platform Expansion) — ideal but not blocking; can harden available
  platforms first and extend to new platforms later

## Deliverables

Confidence to ship. Published benchmark results. 90%+ coverage enforced
across all packages.

## Work Items

### 10.1 Error Handling Audit

- [ ] Verify `catch_unwind` at every Rust FFI entry point
- [ ] OOM, timeout, stack overflow -> `MontyResult.error` with correct `excType`
- [ ] `MontyException` hierarchy: verify full traceback + excType for all
      error paths (new in M7A)
- [ ] Double-free and use-after-dispose protection
- [ ] kwargs/callId/methodCall accessors safe when not in pending state
- [ ] Print callback error handling (callback throws)

### 10.2 Stress Tests

- [ ] Concurrent Isolates with independent Monty instances
- [ ] Large inputs (1MB+ code, deeply nested data)
- [ ] Deep recursion hitting stack limits — verify `RecursionError` excType
- [ ] Timeout accuracy (within 10% tolerance)
- [ ] Memory limit accuracy
- [ ] Allocation limit accuracy (`maxAllocations` from M7B)
- [ ] Rapid create/dispose cycles (100+ iterations, check for leaks)
- [ ] Large bytes round-trip (1MB+ `MontyBytes` through bridge)
- [ ] Print streaming under high volume (1000+ print calls)

### 10.3 Comprehensive Snapshot Portability

- [ ] Dart native -> Dart WASM round-trip
- [ ] Dart native -> Python (`pydantic-monty`) round-trip
- [ ] Dart native -> JS (`@pydantic/monty`) round-trip (if same rev)
- [ ] x86_64 native <-> aarch64 native
- [ ] Web -> mobile and reverse (if M9 complete)
- [ ] Version compatibility matrix
- [ ] Snapshots with rich types (MontyTuple, MontySet, MontyBytes)

### 10.4 Performance Benchmarks

- [ ] Baseline: Monty Rust native (no FFI)
- [ ] Dart FFI overhead
- [ ] Flutter Isolate overhead
- [ ] JS interop / WASM overhead
- [ ] Rich type parsing overhead vs flat JSON
- [ ] Bytes binary path vs JSON integer array
- [ ] Metrics: startup, throughput, memory, snapshot size
- [ ] Published in `docs/benchmarks.md`

### 10.5 Automated Test Suite

- [ ] `tool/test_all.sh` — runs every platform's test suite
- [ ] `tool/test_stress.sh` — stress tests only
- [ ] `tool/test_snapshots.sh` — cross-platform snapshot matrix
- [ ] `tool/benchmark.sh` — performance benchmarks

### 10.6 Dartdoc

- [ ] Dartdoc audit across all packages — verify coverage of public API
- [ ] Benchmark results linked from package-level dartdoc
- [ ] `dart doc` clean build for all packages, no warnings

## Platform Support

| Platform | Status | Notes |
|----------|--------|-------|
| macOS (native FFI) | Full | Primary hardening target |
| Linux (native FFI) | Full | CI-driven |
| Web (WASM/JS) | Full | Browser stress tests, WASM memory limits |
| Windows | If M9 complete | Extend stress tests to Windows runner |
| iOS / Android | If M9 complete | Extend to mobile simulators/emulators |

**Platform-specific considerations:**
- Memory leak detection: `leaks` on macOS, `valgrind` on Linux,
  browser DevTools memory profiling on web
- WASM has a fixed linear memory — stress tests should verify behavior
  at WASM memory limits (typically 256 MB default, up to 4 GB)
- Mobile stress tests should include backgrounding/foregrounding the app
  during execution (if M9 is complete)

## Quality Gate

```bash
# All packages:
tool/test_all.sh
# Every package must have >= 90% coverage
# Zero analyzer warnings across all packages
# All stress tests pass
# All snapshot portability tests pass
```

## Test Dependencies

| Tool | Purpose |
|------|---------|
| All from M1-M9 | Full platform matrix |
| `pydantic-monty` (Python) | Cross-platform snapshot tests |
| `valgrind` or `leaks` | Memory leak detection |
