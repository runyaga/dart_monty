# M8: Hardening and Cross-Platform Testing

## Goal

Production-ready quality. Stress tests, comprehensive snapshot portability,
performance benchmarks, and full coverage enforcement.

## Deliverable

Confidence to ship. Published benchmark results. 90%+ coverage enforced.

## Work Items

### 8.1 Error Handling Audit

- [ ] Verify `catch_unwind` at every Rust FFI entry point
- [ ] OOM, timeout, stack overflow -> `MontyResult.error`
- [ ] `MontyException` hierarchy with structured info
- [ ] Double-free and use-after-dispose protection

### 8.2 Stress Tests

- [ ] Concurrent Isolates with independent Monty instances
- [ ] Large inputs (1MB+ code, deeply nested data)
- [ ] Deep recursion hitting stack limits
- [ ] Timeout accuracy (within 10% tolerance)
- [ ] Memory limit accuracy
- [ ] Rapid create/dispose cycles (100+ iterations, check for leaks)

### 8.3 Comprehensive Snapshot Portability

- [ ] Dart native -> Dart WASM round-trip
- [ ] Dart native -> Python (`pydantic-monty`) round-trip
- [ ] Dart native -> JS (`@pydantic/monty`) round-trip (if same rev)
- [ ] x86_64 native <-> aarch64 native
- [ ] Web -> mobile and reverse
- [ ] Version compatibility matrix

### 8.4 Performance Benchmarks

- [ ] Baseline: Monty Rust native (no FFI)
- [ ] Dart FFI overhead
- [ ] Flutter Isolate overhead
- [ ] JS interop / WASM overhead
- [ ] Metrics: startup, throughput, memory, snapshot size
- [ ] Published in `docs/benchmarks.md`

### 8.5 Automated Test Suite

- [ ] `tool/test_all.sh` -- runs every platform's test suite
- [ ] `tool/test_stress.sh` -- stress tests only
- [ ] `tool/test_snapshots.sh` -- cross-platform snapshot matrix
- [ ] `tool/benchmark.sh` -- performance benchmarks

## Quality Gate

```bash
# All packages:
tool/test_all.sh
# Every package must have >= 90% coverage
# Zero analyzer warnings across all packages
# All stress tests pass
# All snapshot portability tests pass
```

## Test Dependencies

| Tool | Purpose |
|------|---------|
| All from M1-M7 | Full platform matrix |
| `pydantic-monty` (Python) | Cross-platform snapshot tests |
| `valgrind` or `leaks` | Memory leak detection |
