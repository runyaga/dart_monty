# M11: OS Calls

## Goal

Handle `RunProgress::OsCall` — the progress variant yielded when Python
code calls `os.getenv()`, `os.environ`, `os.stat()`, and related OS
functions. The host (Dart) intercepts these calls and provides responses,
maintaining full sandbox control over what the Python code can see.

## Risk Addressed

- Any Python code that touches `os.getenv()` or `os.environ` currently
  fails with an unrecognized progress state
- Agent-generated code commonly reads environment variables for config
- No virtual filesystem metadata (stat, dir_stat) available to sandboxed code

## Dependencies

- M7A (data model fidelity) — excType helps report `FileNotFoundError`
  and `KeyError` from OS call failures
- M2 (Rust C FFI layer) — new progress variant handling

## Deliverables

### Platform Interface Changes (`dart_monty_platform_interface`)

- `MontyOsCall` — new `MontyProgress` variant with `osFunction` and arguments
- `OsFunction` enum: `Environ`, `Getenv`, `Stat`, `DirStat`, `FileStat`,
  `SymlinkStat`
- `MontyPlatform.resumeOsCall(Object? value)` — or reuse existing
  `resume()`/`resumeWithError()` for OS call responses
- `MontyStatResult` model for file stat responses

### Native C FFI Changes (`native/`)

- Handle `RunProgress::OsCall` tag in progress enum
- New accessor: `monty_pending_os_function(handle) -> *const c_char`
- New accessor: `monty_pending_os_args_json(handle) -> *const c_char`
- Resume OS call with value or error

### JS Bridge Changes (`dart_monty_wasm`)

- Handle OS call progress from Worker
- Pass OS function name and arguments to Dart
- Accept host response and resume

## Work Items

### 11.1 Platform Interface

- [ ] `MontyOsCall` progress variant
- [ ] `OsFunction` enum with all upstream OS call types
- [ ] `MontyStatResult` model (size, mtime, mode, etc.)
- [ ] Resume protocol for OS calls
- [ ] Unit tests for new types

### 11.2 Rust C FFI

- [ ] Detect `RunProgress::OsCall` tag in progress dispatch
- [ ] `monty_pending_os_function` accessor
- [ ] `monty_pending_os_args_json` accessor
- [ ] Resume path for OS calls (value or error)
- [ ] Rust unit tests

### 11.3 FFI Implementation

- [ ] `MontyFfi`: recognize OS call progress state
- [ ] Construct `MontyOsCall` from native accessors
- [ ] Resume OS call through native layer
- [ ] Mock-based unit tests (>= 90% coverage)
- [ ] Integration tests: `os.getenv`, `os.environ`, `os.stat`

### 11.4 WASM Implementation

- [ ] `MontyWasm`: recognize OS call progress from Worker
- [ ] Resume OS call through JS bridge
- [ ] Unit tests (>= 90% coverage)

### 11.5 Ladder Runner Updates

- [ ] Native runner: parse `osCallResponses` from fixtures
- [ ] Native runner: detect MontyOsCall progress variant, respond with
      configured values per OsFunction
- [ ] Web runner: mirror all native runner changes

### 11.6 Ladder Tests

- [ ] Tier 11 fixtures (OS calls): IDs 150-156, remove xfail
- [ ] All fixtures pass on both native and web runners
- [ ] JSONL parity verified

### 11.7 Dartdoc

- [ ] Dartdoc comments on `MontyOsCall`, `OsFunction`, `MontyStatResult`
- [ ] Document virtual environment pattern in package-level dartdoc
- [ ] Code examples showing host-controlled environment and filesystem
- [ ] `dart doc` generates cleanly with no warnings

## Ladder Tiers Unlocked

| Tier | Name | Fixture IDs | Count |
|------|------|-------------|-------|
| 11 | OS calls | 150-156 | 7 |

## Demos Unlocked

- **Demo 7:** Sandboxed Environment & File System Access

### Validation Artifacts

The ladder fixtures (tier 11) are built and passing as part of this
milestone. Demo application (7) is identified as a showcase target
but detailed demo design — including web vs desktop platform choice,
UI treatment, and user flow — is deferred to a separate
visioning/planning process after milestone reorganization.

## Dart Layer

**Pure Dart** — no Flutter SDK dependency. Validated by the ladder
runner (CLI + web).

## Platform Support

| Platform | Status | Notes |
|----------|--------|-------|
| macOS (native FFI) | Full | New progress variant in C FFI |
| Linux (native FFI) | Full | Same C API |
| Web (WASM/JS) | Full | OS calls yield through Worker, host responds |
| Windows | After M9 | Same C API, no platform-specific OS call behavior |
| iOS / Android | After M9 | Same C API |

**Platform-specific considerations:**
- OS calls are fully sandboxed — the Python code never touches the real
  OS. The host provides all responses. This means OS call behavior is
  identical across platforms.
- The interesting platform question is what _values_ the host provides.
  On mobile, `os.stat` paths are meaningless; the host decides policy.

## Quality Gate

```bash
bash tool/test_m1.sh
bash tool/test_m3a.sh
bash tool/test_wasm.sh
bash tool/test_python_ladder.sh
bash tool/test_cross_path_parity.sh
```
