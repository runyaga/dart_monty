# M6: Flutter Web Plugin

**Prerequisite:** M4 (pure Dart WASM package) complete.

## Goal

Flutter web plugin wrapping the pure Dart WASM package (M4) with
federated plugin registration and JS asset bundling.

## Risk Addressed

- **R8** (federated plugin wiring -- web platform)

## Deliverable

`packages/dart_monty_web` -- Flutter web plugin implementing `dart_monty`.

## Usable For

Flutter web apps.

## Work Items

### 6.1 Federated Registration

`packages/dart_monty_web/pubspec.yaml`:

```yaml
flutter:
  plugin:
    implements: dart_monty
    platforms:
      web:
        pluginClass: DartMontyWeb
        fileName: dart_monty_web.dart
```

Root pubspec adds:

```yaml
flutter:
  plugin:
    platforms:
      web:
        default_package: dart_monty_web
```

### 6.2 Implementation

- [x] Wraps `dart_monty_wasm` (pure Dart, from M4)
- [x] `registerWith()` sets `MontyPlatform.instance = DartMontyWeb()`
- [x] No Isolate needed -- web execution is async by nature
- [x] `@visibleForTesting` constructor for dependency injection
- [x] COOP/COEP via `coi-serviceworker.js` for deployment

### 6.3 Automated Tests

- [x] `tool/test_web.sh`: pub get, format, analyze, flutter test --platform chrome
- [x] 52 unit tests covering all API methods (run, start, resume, resumeWithError,
  snapshot, restore, dispose, registerWith, state machine, auto-init)
- [x] Mock-based testing via `MockWasmBindings` (no JS bridge needed)

### 6.4 Flutter Web Example App

- [x] `example/flutter_web/` -- Flutter Material app with 4 tabs:
  - **Examples:** Python REPL with resource limits, HTTP fetch, error injection
  - **Sorting:** 8 algorithms with animated bar chart visualizer
  - **TSP:** Nearest neighbor and 2-opt with route canvas
  - **Ladder:** Cross-platform fixture runner (loads via HTTP)
- [x] Uses `MontyPlatform.instance` for examples, fresh `DartMontyWeb()` for
  visualizer/TSP/ladder (independent lifecycle with dispose)
- [x] `package:http` for browser-compatible HTTP requests

### 6.5 Demo Site Integration

- [x] Landing page (`example/web/web/index.html`) updated with "Flutter Web" section
- [x] `pages.yaml` builds Flutter web app and deploys at `/flutter/` subdirectory
- [x] WASM assets + fixtures copied into Flutter build output

### CI Expansion

- [x] `test-web` job in `.github/workflows/ci.yaml`:
  `flutter test --platform chrome` on ubuntu-latest
- [x] Pre-commit hooks in `.pre-commit-config.yaml`:
  `flutter-test-web` and `flutter-analyze-web`

Note: Coverage instrumentation is not available for Chrome-platform tests in
Flutter. The underlying `MontyWasm` logic has 100% coverage in `dart_monty_wasm`.

## Quality Gate

```bash
bash tool/test_web.sh
# Runs: pub get, format, analyze (--no-fatal-warnings), flutter test --platform chrome
```

## Test Dependencies

| Tool | Purpose |
|------|---------|
| Flutter SDK | Plugin framework |
| Chrome (headless) | Browser test runner |
| JS wrapper from M4 | Monty WASM bridge |
