# M1: Pure Dart Platform Interface

## Goal

Establish the API contract, value types, and mock implementation as a
pure Dart package with zero Flutter dependency. Any Dart program can
import the types and code against the contract.

## Risk Addressed

None (low risk phase). Establishes the contract that all subsequent
milestones implement against.

## Deliverable

`packages/dart_monty_platform_interface` -- pure Dart package publishable
to pub.dev.

## Usable For

- Defining APIs before native code exists
- Writing mock-based tests in downstream packages
- Building higher-level abstractions
- Dart CLI tools, servers, scripts -- anything that imports the types

## Work Items

### 1.1 Value Types

- [ ] `MontyResult` -- execution result with value, error, resource usage
- [ ] `MontyProgress` -- sealed type: `MontyComplete` | `MontyPending`
- [ ] `MontyPending` -- external function call request (name + args)
- [ ] `MontyLimits` -- resource limit configuration
- [ ] `MontyResourceUsage` -- actual resource consumption after execution
- [ ] `MontyException` -- structured error with source location info
- [ ] JSON serialization for all value types (`toJson()` / `fromJson()`)
- [ ] `toString()` for all types (useful for debugging)
- [ ] `==` and `hashCode` for all types (value equality)

### 1.2 Platform Contract

- [ ] `MontyPlatform` abstract class defining the full API:
  - `run()` -- simple execution
  - `start()` -- iterative execution (returns `MontyProgress`)
  - `resume(Object? returnValue)` -- continue after external fn
  - `resumeWithError(String errorMessage)` -- inject Python exception
  - `snapshot()` -- serialize state to `Uint8List`
  - `restore(Uint8List data)` -- deserialize state
  - `dispose()` -- release resources
- [ ] No Flutter imports. No method channels. Pure Dart only.
- [ ] `MontyPlatform.instance` getter/setter for registration

### 1.3 Mock Implementation

- [ ] `MockMontyPlatform` implementing the contract with canned responses
- [ ] Configurable: set expected inputs, return values, external fn calls
- [ ] Useful for downstream consumers to test without native code

### 1.4 Tests

- [ ] Unit tests for every value type (construction, equality, JSON round-trip)
- [ ] Unit tests for `MontyPlatform` contract compliance
- [ ] Unit tests for mock implementation
- [ ] Edge cases: null values, empty collections, large strings, BigInt

## Quality Gate

All must pass before M1 is complete:

```bash
cd packages/dart_monty_platform_interface
dart pub get
dart format --set-exit-if-changed .
dart analyze --fatal-infos
dart test --coverage=coverage
# Coverage must be >= 90%
```

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `plugin_platform_interface` | `^2.1.8` | Abstract platform contract |
| `very_good_analysis` | `^10.0.0` | Strict linting (dev) |
| `mocktail` | `^1.0.4` | Test mocking (dev) |
| `test` | `^1.25.0` | Test runner (dev) |
| `coverage` | latest | Coverage collection (dev) |

## Test Runner

```bash
dart test
```

No native libraries, no browser, no Flutter SDK.
