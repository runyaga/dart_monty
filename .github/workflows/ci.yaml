name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - run: dart format --set-exit-if-changed .
      - name: Install libclang (for ffigen)
        run: sudo apt-get update && sudo apt-get install -y libclang-dev
      - name: Generate FFI bindings
        run: bash tool/generate_bindings.sh
      - name: Analyze sub-packages
        run: python3 tool/analyze_packages.py

  markdown:
    name: Markdown lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install pymarkdownlnt
      - name: pymarkdown scan
        run: >-
          pymarkdown
          --set extensions.front-matter.enabled=\$!True
          --disable-rules MD013,MD024,MD033,MD036,MD041,MD060
          scan **/*.md

  test:
    name: Test (${{ matrix.target }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint]
    strategy:
      matrix:
        target:
          - dart_monty_platform_interface
          - dart_monty_ffi
          - dart_monty_wasm
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Install libclang (for ffigen)
        if: matrix.target == 'dart_monty_ffi'
        run: sudo apt-get update && sudo apt-get install -y libclang-dev
      - name: Generate FFI bindings
        if: matrix.target == 'dart_monty_ffi'
        run: bash tool/generate_bindings.sh
      - name: Install dependencies
        run: cd packages/${{ matrix.target }} && dart pub get
      - name: Run tests
        run: cd packages/${{ matrix.target }} && dart test --coverage=coverage
      - name: Check coverage (platform_interface)
        if: matrix.target == 'dart_monty_platform_interface'
        run: |
          cd packages/dart_monty_platform_interface
          dart pub global activate coverage
          dart pub global run coverage:format_coverage \
            --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          TOTAL=$(grep -c '^DA:' coverage/lcov.info || true)
          HIT=$(grep '^DA:' coverage/lcov.info | grep -cv ',0$' || true)
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No coverage data found."
            exit 1
          fi
          PCT=$(( HIT * 100 / TOTAL ))
          echo "Coverage: $HIT/$TOTAL lines = ${PCT}%"
          if [ "$PCT" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi
      - name: Check coverage (ffi)
        if: matrix.target == 'dart_monty_ffi'
        run: |
          cd packages/dart_monty_ffi
          dart pub global activate coverage
          dart pub global run coverage:format_coverage \
            --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          TOTAL=$(grep -c '^DA:' coverage/lcov.info || true)
          HIT=$(grep '^DA:' coverage/lcov.info | grep -cv ',0$' || true)
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No coverage data found."
            exit 1
          fi
          PCT=$(( HIT * 100 / TOTAL ))
          echo "Coverage: $HIT/$TOTAL lines = ${PCT}%"
          if [ "$PCT" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi
      - name: Check coverage (wasm)
        if: matrix.target == 'dart_monty_wasm'
        run: |
          cd packages/dart_monty_wasm
          dart pub global activate coverage
          dart pub global run coverage:format_coverage \
            --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          TOTAL=$(grep -c '^DA:' coverage/lcov.info || true)
          HIT=$(grep '^DA:' coverage/lcov.info | grep -cv ',0$' || true)
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No coverage data found."
            exit 1
          fi
          PCT=$(( HIT * 100 / TOTAL ))
          echo "Coverage: $HIT/$TOTAL lines = ${PCT}%"
          if [ "$PCT" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: packages/${{ matrix.target }}/coverage/lcov.info
          flags: ${{ matrix.target }}

  test-desktop:
    name: Test (dart_monty_desktop)
    runs-on: macos-latest
    timeout-minutes: 15
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Install libclang (for ffigen)
        run: HOMEBREW_NO_AUTO_UPDATE=1 brew install llvm
      - name: Generate FFI bindings
        run: bash tool/generate_bindings.sh
      - name: Install dependencies
        run: cd packages/dart_monty_desktop && flutter pub get
      - name: Run tests
        run: cd packages/dart_monty_desktop && flutter test --coverage
      - name: Check coverage
        run: |
          cd packages/dart_monty_desktop
          TOTAL=$(grep -c '^DA:' coverage/lcov.info || true)
          HIT=$(grep '^DA:' coverage/lcov.info | grep -cv ',0$' || true)
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No coverage data found."
            exit 1
          fi
          PCT=$(( HIT * 100 / TOTAL ))
          echo "Coverage: $HIT/$TOTAL lines = ${PCT}%"
          if [ "$PCT" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: packages/dart_monty_desktop/coverage/lcov.info
          flags: dart_monty_desktop

  build-js-wrapper:
    name: Build JS wrapper
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/dart_monty_wasm/js/package-lock.json
      - name: Install dependencies
        working-directory: packages/dart_monty_wasm/js
        run: npm install
      - name: Build bridge and worker
        working-directory: packages/dart_monty_wasm/js
        run: npm run build
      - name: Verify assets
        run: |
          ls -la packages/dart_monty_wasm/assets/
          test -f packages/dart_monty_wasm/assets/dart_monty_bridge.js
          test -f packages/dart_monty_wasm/assets/dart_monty_worker.js
          test -f packages/dart_monty_wasm/assets/wasi-worker-browser.mjs

  wasm-ladder:
    name: WASM ladder integration
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/dart_monty_wasm/js/package-lock.json
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Build JS bridge
        working-directory: packages/dart_monty_wasm/js
        run: npm install && npm run build
      - name: Prepare integration test
        run: |
          PKG=packages/dart_monty_wasm
          INTEG_WEB="$PKG/test/integration/web"
          cp "$PKG/assets/dart_monty_bridge.js" "$INTEG_WEB/"
          cp "$PKG/assets/dart_monty_worker.js" "$INTEG_WEB/"
          cp "$PKG/assets/wasi-worker-browser.mjs" "$INTEG_WEB/"
          cp "$PKG/assets/"*.wasm "$INTEG_WEB/"
          cd "$PKG"
          dart pub get
          dart compile js test/integration/python_ladder_test.dart \
            -o test/integration/web/ladder_runner.dart.js
          mkdir -p test/integration/web/fixtures
          cp ../../test/fixtures/python_ladder/tier_*.json test/integration/web/fixtures/
      - name: Run WASM ladder in headless Chrome
        run: |
          INTEG_WEB="packages/dart_monty_wasm/test/integration/web"
          SERVE_PORT=8099

          python3 << 'PYEOF' &
          import http.server, functools, os
          integ = os.environ.get("INTEG_WEB", "packages/dart_monty_wasm/test/integration/web")
          port = int(os.environ.get("SERVE_PORT", "8099"))
          class H(http.server.SimpleHTTPRequestHandler):
              def end_headers(self):
                  self.send_header("Cross-Origin-Opener-Policy", "same-origin")
                  self.send_header("Cross-Origin-Embedder-Policy", "require-corp")
                  self.send_header("Access-Control-Allow-Origin", "*")
                  self.send_header("Cache-Control", "no-store")
                  super().end_headers()
              def guess_type(self, path):
                  if path.endswith(".mjs"): return "application/javascript"
                  if path.endswith(".wasm"): return "application/wasm"
                  return super().guess_type(path)
              def log_message(self, fmt, *args): pass
          handler = functools.partial(H, directory=integ)
          http.server.HTTPServer(("127.0.0.1", port), handler).serve_forever()
          PYEOF
          sleep 2

          CHROME="google-chrome-stable"
          LADDER_LOG=$(mktemp)

          timeout 120 "$CHROME" \
            --headless \
            --disable-gpu \
            --no-sandbox \
            --disable-dev-shm-usage \
            --enable-logging=stderr \
            --v=0 \
            "http://127.0.0.1:$SERVE_PORT/ladder.html" \
            2>"$LADDER_LOG" || true

          WEB_RESULTS=$(grep -o 'LADDER_RESULT:{.*}' "$LADDER_LOG" 2>/dev/null || true)
          LADDER_DONE=$(grep -c 'LADDER_DONE' "$LADDER_LOG" 2>/dev/null || echo "0")

          if [ -z "$WEB_RESULTS" ]; then
            echo "ERROR: No LADDER_RESULT lines captured from Chrome."
            grep -i "CONSOLE" "$LADDER_LOG" | head -20 || true
            rm -f "$LADDER_LOG"
            exit 1
          fi

          echo "$WEB_RESULTS" | while IFS= read -r line; do
            echo "  $line"
          done

          TOTAL=$(echo "$WEB_RESULTS" | wc -l | tr -d ' ')
          FAILURES=$(echo "$WEB_RESULTS" | grep -c '"ok":false' || echo "0")

          rm -f "$LADDER_LOG"

          echo ""
          echo "Results: $TOTAL fixtures, $FAILURES failures"

          if [ "$FAILURES" -gt 0 ]; then
            echo "FAIL: WASM ladder had $FAILURES bridge failures"
            exit 1
          fi

          if [ "$LADDER_DONE" -eq 0 ]; then
            echo "WARN: LADDER_DONE signal not found"
          fi

          echo "WASM ladder: PASSED ($TOTAL fixtures)"
        env:
          INTEG_WEB: packages/dart_monty_wasm/test/integration/web
          SERVE_PORT: "8099"

  build-native:
    name: Build native (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [lint, test]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: Build Rust native library
        working-directory: native
        run: cargo build --release

  build-smoke:
    name: Build smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: [lint]
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: macos
          - os: ubuntu-latest
            target: linux
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: Install Linux desktop dependencies
        if: matrix.os == 'ubuntu-latest'
        run: >-
          sudo apt-get update && sudo apt-get install -y
          clang cmake ninja-build pkg-config libgtk-3-dev libclang-dev
      - name: Install libclang (macOS)
        if: matrix.os == 'macos-latest'
        run: HOMEBREW_NO_AUTO_UPDATE=1 brew install llvm
      - name: Generate FFI bindings
        run: bash tool/generate_bindings.sh
      - name: Build native library and copy to plugin
        run: bash tool/build_native.sh
      - name: Install dependencies
        run: cd example/desktop && flutter pub get
      - name: Build
        run: cd example/desktop && flutter build ${{ matrix.target }}

  rust-cargo-test:
    name: Rust tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: cargo fmt
        working-directory: native
        run: cargo fmt --check
      - name: cargo clippy
        working-directory: native
        run: cargo clippy -- -D warnings
      - name: cargo test
        working-directory: native
        run: cargo test

  rust-coverage:
    name: Rust coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [rust-cargo-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: Install cargo-tarpaulin
        uses: taiki-e/install-action@cargo-tarpaulin
      - name: Run tarpaulin
        working-directory: native
        run: |
          OUTPUT=$(cargo tarpaulin --out Xml --output-dir target/tarpaulin 2>&1)
          echo "$OUTPUT"
          PCT=$(echo "$OUTPUT" | grep -oP '\d+\.\d+% coverage' | grep -oP '\d+\.\d+' | tail -1 || echo "0")
          echo "Coverage: ${PCT}%"
          WHOLE=${PCT%%.*}
          if [ "${WHOLE:-0}" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: native/target/tarpaulin/cobertura.xml
          flags: native

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [rust-cargo-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1-threads
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: Build WASM
        working-directory: native
        run: cargo build --release --target wasm32-wasip1-threads

  security:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
