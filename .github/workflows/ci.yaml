name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - run: dart format --set-exit-if-changed .
      - name: Install libclang (for ffigen)
        run: sudo apt-get update && sudo apt-get install -y libclang-dev
      - name: Generate FFI bindings
        run: bash tool/generate_bindings.sh
      - name: Analyze sub-packages
        run: python3 tool/analyze_packages.py

  dcm:
    name: DCM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - uses: CQLabs/setup-dcm@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: CQLabs/dcm-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          ci-key: ${{ secrets.DCM_CI_KEY }}
          email: ${{ secrets.DCM_EMAIL }}
          analyze: true
          folders: packages
      - name: Upload to DCM Dashboard
        if: github.ref == 'refs/heads/main'
        run: >-
          dcm run packages
          --ci-key=${{ secrets.DCM_CI_KEY }}
          --email=${{ secrets.DCM_EMAIL }}
          --project=${{ secrets.DCM_PROJECT_KEY }}
          --analyze
          --upload

  markdown:
    name: Markdown lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install pymarkdownlnt
      - name: pymarkdown scan
        run: >-
          pymarkdown
          --set extensions.front-matter.enabled=\$!True
          --disable-rules MD013,MD024,MD033,MD036,MD041,MD060
          scan **/*.md

  test:
    name: Test (${{ matrix.target }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, dcm]
    strategy:
      matrix:
        target:
          - dart_monty_platform_interface
          - dart_monty_ffi
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Install libclang (for ffigen)
        if: matrix.target == 'dart_monty_ffi'
        run: sudo apt-get update && sudo apt-get install -y libclang-dev
      - name: Generate FFI bindings
        if: matrix.target == 'dart_monty_ffi'
        run: bash tool/generate_bindings.sh
      - name: Install dependencies
        run: cd packages/${{ matrix.target }} && dart pub get
      - name: Run tests
        run: cd packages/${{ matrix.target }} && dart test --coverage=coverage
      - name: Check coverage (platform_interface)
        if: matrix.target == 'dart_monty_platform_interface'
        run: |
          cd packages/dart_monty_platform_interface
          dart pub global activate coverage
          dart pub global run coverage:format_coverage \
            --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          TOTAL=$(grep -c '^DA:' coverage/lcov.info || true)
          HIT=$(grep '^DA:' coverage/lcov.info | grep -cv ',0$' || true)
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No coverage data found."
            exit 1
          fi
          PCT=$(( HIT * 100 / TOTAL ))
          echo "Coverage: $HIT/$TOTAL lines = ${PCT}%"
          if [ "$PCT" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi
      - name: Check coverage (ffi)
        if: matrix.target == 'dart_monty_ffi'
        run: |
          cd packages/dart_monty_ffi
          dart pub global activate coverage
          dart pub global run coverage:format_coverage \
            --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          TOTAL=$(grep -c '^DA:' coverage/lcov.info || true)
          HIT=$(grep '^DA:' coverage/lcov.info | grep -cv ',0$' || true)
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No coverage data found."
            exit 1
          fi
          PCT=$(( HIT * 100 / TOTAL ))
          echo "Coverage: $HIT/$TOTAL lines = ${PCT}%"
          if [ "$PCT" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi

  build-native:
    name: Build native (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [lint, test]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: Build Rust native library
        working-directory: native
        run: cargo build --release

  rust-cargo-test:
    name: Rust tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: cargo fmt
        working-directory: native
        run: cargo fmt --check
      - name: cargo clippy
        working-directory: native
        run: cargo clippy -- -D warnings
      - name: cargo test
        working-directory: native
        run: cargo test

  rust-coverage:
    name: Rust coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [rust-cargo-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin
      - name: Run tarpaulin
        working-directory: native
        run: |
          OUTPUT=$(cargo tarpaulin --out Xml --output-dir target/tarpaulin 2>&1)
          echo "$OUTPUT"
          PCT=$(echo "$OUTPUT" | grep -oP '\d+\.\d+% coverage' | grep -oP '\d+\.\d+' | tail -1 || echo "0")
          echo "Coverage: ${PCT}%"
          WHOLE=${PCT%%.*}
          if [ "${WHOLE:-0}" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [rust-cargo-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1-threads
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: native
      - name: Build WASM
        working-directory: native
        run: cargo build --release --target wasm32-wasip1-threads

  security:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
