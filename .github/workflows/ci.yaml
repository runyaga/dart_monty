name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - run: dart format --set-exit-if-changed .
      - name: Analyze sub-packages
        run: python3 tool/analyze_packages.py

  dcm:
    name: DCM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - uses: CQLabs/setup-dcm@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: CQLabs/dcm-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          ci-key: ${{ secrets.DCM_CI_KEY }}
          email: ${{ secrets.DCM_EMAIL }}
          analyze: true
          folders: lib,packages

  markdown:
    name: Markdown lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install pymarkdownlnt
      - name: pymarkdown scan
        run: >-
          pymarkdown
          --set extensions.front-matter.enabled=\$!True
          --disable-rules MD013,MD024,MD033,MD036,MD041,MD060
          scan **/*.md

  test:
    name: Test (${{ matrix.target }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, dcm]
    strategy:
      matrix:
        target:
          - app
          - dart_monty_platform_interface
          - dart_monty_ffi
          - dart_monty_web
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install dependencies
        run: |
          if [ "${{ matrix.target }}" = "app" ]; then
            flutter pub get
          else
            cd packages/${{ matrix.target }} && dart pub get
          fi
      - name: Run tests
        run: |
          if [ "${{ matrix.target }}" = "app" ]; then
            flutter test --coverage
          else
            cd packages/${{ matrix.target }} && dart test --coverage=coverage
          fi
      - name: Check coverage (platform_interface)
        if: matrix.target == 'dart_monty_platform_interface'
        run: |
          cd packages/dart_monty_platform_interface
          dart pub global activate coverage
          dart pub global run coverage:format_coverage \
            --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          TOTAL=$(grep -c '^DA:' coverage/lcov.info || true)
          HIT=$(grep '^DA:' coverage/lcov.info | grep -cv ',0$' || true)
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No coverage data found."
            exit 1
          fi
          PCT=$(( HIT * 100 / TOTAL ))
          echo "Coverage: $HIT/$TOTAL lines = ${PCT}%"
          if [ "$PCT" -lt 90 ]; then
            echo "FAIL: Coverage ${PCT}% < 90% minimum."
            exit 1
          fi

  build-native:
    name: Build native (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [lint, test]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Build Rust native library
        working-directory: native
        run: cargo build --release

  security:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
